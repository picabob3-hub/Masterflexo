<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Masterflexo - Control Total</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d47a1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { --p-color: #0d47a1; --s-color: #4a148c; --bg: #f0f2f5; --ws-color: #25d366; --gear-gray: #bdc3c7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .master-wrapper { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        .main-header { padding: 10px 15px; background: white; display: flex; justify-content: space-between; align-items: center; }
        .header-strip { background-color: var(--p-color); height: 45px; border-radius: 10px; margin: 5px 15px; display: flex; align-items: center; justify-content: flex-end; padding: 0 15px; }
        #logo-preview { max-width: 140px; max-height: 55px; object-fit: contain; display: none; }
        .settings-gear { cursor: pointer; color: var(--gear-gray); font-size: 26px; }

        .nav-tabs { display: flex; background: #f8f9fa; padding: 10px; gap: 10px; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; background: #e0e0e0; color: #666; font-size: 11px; }
        .tab-btn.active.cirel-tab { background: var(--p-color); color: white; }
        .tab-btn.active.flexo-tab { background: var(--s-color); color: white; }

        .shared-data { padding: 15px; border-bottom: 5px solid #f0f2f5; }
        .grid-inputs { display: flex; flex-direction: column; gap: 8px; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-weight: bold; font-size: 10px; color: #888; text-transform: uppercase; }
        input { padding: 12px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 16px; text-align: right; width: 100%; box-sizing: border-box; }
        input:disabled { background: #f5f5f5; color: #999; border: 1px dashed #ccc; }
        
        .module { display: none; padding: 15px; }
        .module.active { display: block; }

        .res-valor { padding: 10px; border-radius: 8px; font-weight: bold; text-align: right; font-size: 13px; margin-bottom: 4px; }
        .res-blue { background-color: #e3f2fd; color: #0d47a1; }
        .res-purple { background-color: #f3e5f5; color: #4a148c; }
        .res-green { background-color: #e8f5e9; color: #1b5e20; }
        .res-orange { background-color: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }

        .tech-icons-row { display: flex; justify-content: space-between; margin: 15px 0; gap: 15px; padding: 0 10px; }
        .app-icon { flex: 0 0 65px; height: 65px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: none; }
        .app-icon span { font-size: 20px; color: white; margin-bottom: 2px; }
        .app-icon p { font-size: 8px; margin: 0; font-weight: bold; color: white; }
        .ic-opt { background: #4caf50; }
        .ic-tall { background: #607d8b; }
        .ic-vis { background: #2196f3; }

        .mode-selector { display: flex; background: #eee; border-radius: 8px; margin-bottom: 12px; padding: 4px; gap: 4px; }
        .mode-btn { flex: 1; border: none; padding: 10px; font-size: 9px; font-weight: bold; border-radius: 6px; cursor: pointer; background: #ddd; color: #777; }
        .mode-btn.active { background: var(--p-color); color: white; }

        .collapsible-content { display: none; background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-top: 10px; }
        .tabla-opt { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px;}
        .tabla-opt td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .mejor-fila { background-color: #c8e6c9 !important; font-weight: bold; border: 2px solid #2e7d32; }

        #vis-container { padding: 45px 10px 10px 65px; display: flex; flex-direction: column; align-items: center; }
        #area-cirel { position: relative; border: 1.5px solid #333; background: #fff; }
        .etiqueta-v { position: absolute; background: #333; }
        
        .cota { position: absolute; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--p-color); }
        .cota-h { width: 100%; height: 15px; top: -30px; border-left: 1px solid var(--p-color); border-right: 1px solid var(--p-color); border-bottom: 1px solid var(--p-color); }
        .cota-v { height: 100%; width: 15px; left: -30px; flex-direction: column; border-top: 1px solid var(--p-color); border-bottom: 1px solid var(--p-color); border-right: 1px solid var(--p-color); }
        .cota-text-v { position: absolute; left: -55px; transform: rotate(-90deg); white-space: nowrap; width: 120px; text-align: center; }

        .f-material-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .f-mat-card { background: #f9f4ff; border: 1px solid #e1bee7; padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: flex-start; gap: 10px; cursor: pointer; transition: 0.2s; }
        .f-mat-card.selected { border: 2px solid var(--s-color); background: #f3e5f5; }
        .f-mat-card span { font-size: 11px; font-weight: bold; color: var(--s-color); text-align: left; line-height: 1.2; }
        .f-mat-card input { width: auto; margin: 0; pointer-events: none; }

        .total-box { padding: 15px; border-radius: 15px; text-align: right; margin-top: 15px; border: 1px solid #eee; }
        .total-val { font-size: 24px; font-weight: bold; }
        .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        #config-panel, #info-logic-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; }
        .config-content { background: white; width: 90%; max-width: 450px; margin: 20px auto; padding: 20px; border-radius: 20px; position: relative; }

        .print-only { display: none; }
        @media print {
            .no-print, .nav-tabs, .tech-icons-row, .btn-action, .settings-gear, .header-strip, .mode-selector, 
            #sec_opt, #sec_vis, .f-material-grid, #config-panel, #info-logic-panel, 
            .extra-input-row, #f_msg { 
                display: none !important; 
            }
            body { background: white; padding: 0; margin: 0; }
            .master-wrapper { box-shadow: none; max-width: 100%; width: 100%; margin: 0; border: none; }
            input { border: none !important; background: transparent !important; text-align: left !important; padding: 0 !important; font-size: 12pt !important; height: auto !important; color: black !important; }
            .shared-data { border-bottom: 2px solid #333; margin-bottom: 10px; padding: 10px 0; }
            .res-valor { background: none !important; border-bottom: 1px solid #ddd; color: #000 !important; padding: 5px !important; border-radius: 0; }
            .total-box { border: 2px solid #000 !important; background: #fff !important; color: #000 !important; border-radius: 10px; }
            .total-val { color: #000 !important; }
            
            .print-only { display: block !important; }
            .print-title { font-size: 28pt; font-weight: bold; color: #e0e0e0; text-align: center; margin: 10px 0; text-transform: uppercase; }
            
            .firma-box { margin-top: 80px; display: flex; justify-content: center; }
            .firma-line { border-top: 1px solid #000; width: 220px; text-align: center; padding-top: 8px; font-size: 10pt; font-weight: bold; }
        }
    </style>
</head>
<body>

<div class="master-wrapper">
    <header class="main-header"><div class="logo-container"><img id="logo-preview" src=""></div></header>
    
    <div id="main-print-title" class="print-only print-title">PROFORMA</div>

    <div class="header-strip no-print"><span class="settings-gear" onclick="toggleConfig(true)">‚öô</span></div>

    <section class="shared-data">
        <div class="grid-inputs">
            <div><label>CLIENTE</label><input type="text" id="c_nom" placeholder="..."></div>
            <div class="grid-row">
                <div><label>RUC/CI</label><input type="text" id="c_ruc" placeholder="..."></div>
                <div><label>FECHA</label><input type="text" id="fecha" readonly></div>
            </div>
        </div>
    </section>

    <nav class="nav-tabs no-print">
        <button id="btn-cirel" class="tab-btn active cirel-tab" onclick="switchApp('mod_cirel')">CIREL PRO</button>
        <button id="btn-flexo" class="tab-btn flexo-tab" onclick="switchApp('mod_flexo')">FLEXO PRO</button>
    </nav>

    <main id="mod_cirel" class="module active">
        <div class="grid-row">
            <div><label>Ancho mm</label><input type="number" id="cw" value="50" oninput="runCirel()"></div>
            <div><label>Alto mm</label><input type="number" id="ch" value="30" oninput="runCirel()"></div>
            <div><label>Gap H mm</label><input type="number" id="cgh" value="3" oninput="runCirel()"></div>
            <div><label>Gap V mm</label><input type="number" id="cgv" value="3" oninput="runCirel()"></div>
            <div><label>Columnas</label><input type="number" id="ccol" value="2" oninput="runCirel()"></div>
            <div><label>Total Etiq</label><input type="number" id="ctot" value="10" oninput="runCirel()"></div>
        </div>

        <div class="mode-selector no-print" style="margin-top:15px;">
            <button id="mode-guias" class="mode-btn active" onclick="setMasterMode('guias')">CON GU√çAS</button>
            <button id="mode-neto" class="mode-btn" onclick="setMasterMode('neto')">BLOQUE NETO</button>
        </div>

        <div class="grid-row">
            <div><label>Bloque Neto</label><div id="cr_bloque" class="res-valor res-blue">0x0 mm</div></div>
            <div><label id="lbl_aux">Imp+Gu√≠as</label><div id="cr_aux" class="res-valor res-blue">0x0 mm</div></div>
        </div>
        <div><label>√Årea Cobro Final</label><div id="cr_cobro" class="res-valor res-orange">0x0 cm</div></div>

        <div class="tech-icons-row no-print">
            <button class="app-icon ic-opt" onclick="toggleSec('sec_opt')"><span>üìä</span><p>OPTIMIZAR</p></button>
            <button class="app-icon ic-tall" onclick="toggleSec('sec_z')"><span>‚öôÔ∏è</span><p>TALLER Z</p></button>
            <button class="app-icon ic-vis" onclick="toggleSec('sec_vis')"><span>üëÅÔ∏è</span><p>ESQUEMA</p></button>
        </div>

        <div id="sec_opt" class="collapsible-content no-print"><div id="cr_tabla_opt"></div></div>
        <div id="sec_z" class="collapsible-content">
            <div class="grid-row">
                <div><label>Z Cilindro</label><input type="number" id="z_manual" style="background:#333; color:white; text-align:center" oninput="calcZManual()"></div>
                <div><label>Te√≥rico</label><div id="cr_teo" class="res-valor" style="background:#eee;">0 mm</div></div>
            </div>
            <div style="margin-top:5px;"><label>Compensada (-1.7%)</label><div id="cr_comp" class="res-valor res-blue">0 mm</div></div>
        </div>
        <div id="sec_vis" class="collapsible-content">
            <div id="vis-container"><div id="area-cirel"><div class="cota cota-h"><span id="ctx-h" style="background:white; padding:0 3px"></span></div><div class="cota cota-v"><span id="ctx-v" class="cota-text-v"></span></div><div id="vis"></div></div></div>
        </div>

        <div class="grid-row" style="margin-top:10px;">
            <div><label>Cant. Cireles</label><input type="number" id="cn_cir" value="1" oninput="runCirel()"></div>
            <div><label>√Årea Tot cm¬≤</label><div id="cr_area" class="res-valor res-blue">0 cm¬≤</div></div>
        </div>

        <div class="total-box">
            <div style="font-size:12px;">SUBTOTAL: <span id="cr_sub">$ 0.00</span></div>
            <div style="font-size:12px;"><span id="lbl_iva_cirel">IVA:</span> <span id="cr_iva">$ 0.00</span></div>
            <div class="total-val" style="color:var(--p-color);" id="cr_total">$ 0.00</div>
        </div>

        <div class="print-only firma-box"><div class="firma-line">Firma Autorizada</div></div>
        <button class="btn-action no-print" style="background:var(--ws-color); color:white;" onclick="wsAction('cirel')">üí¨ WhatsApp Cirel</button>
        <button class="btn-action no-print" onclick="window.print()">üñ®Ô∏è Imprimir Cirel</button>
    </main>

    <main id="mod_flexo" class="module">
        <div class="grid-row">
            <div><label>Bloque cm</label><input type="number" id="f_cmB" value="22.25" oninput="runFlexo()"></div>
            <div><label>Etiq x Bloque</label><input type="number" id="f_etB" value="6" oninput="runFlexo()"></div>
            <div><label>Total Pedido</label><input type="number" id="f_tot" value="5000" oninput="runFlexo()"></div>
            <div><label>Ancho Mat cm</label><input type="number" id="f_anc" value="10" oninput="runFlexo()"></div>
        </div>

        <h2 class="no-print" style="color:var(--s-color); font-size:11px; margin-top:20px;">M√âTRICAS T√âCNICAS</h2>
        <div class="grid-inputs">
            <div class="grid-row">
                <div><label>Bloques</label><div id="f_res_bloques" class="res-valor res-blue">0</div></div>
                <div><label>Lineal (cm)</label><div id="f_res_cm" class="res-valor res-blue">0</div></div>
            </div>
            <div><label>Superficie (cm¬≤)</label><div id="f_res_area" class="res-valor res-purple">0</div></div>
            <div class="grid-row">
                <div><label>Metros (m)</label><div id="f_res_m" class="res-valor res-green">0</div></div>
                <div><label>Pies (ft)</label><div id="f_res_ft" class="res-valor res-green">0</div></div>
            </div>
        </div>

        <div class="f-material-grid">
            <div class="f-mat-card selected" id="card_v1" onclick="selMat('v1')"><input type="radio" name="fm" id="r_v1" checked><span>PoliP Blanco</span></div>
            <div class="f-mat-card" id="card_v2" onclick="selMat('v2')"><input type="radio" name="fm" id="r_v2"><span>PoliP Trans</span></div>
            <div class="f-mat-card" id="card_v3" onclick="selMat('v3')"><input type="radio" name="fm" id="r_v3"><span>PoliP Metal</span></div>
            <div class="f-mat-card" id="card_v4" onclick="selMat('v4')"><input type="radio" name="fm" id="r_v4"><span>Propalcote B</span></div>
            <div class="f-mat-card" id="card_v5" onclick="selMat('v5')"><input type="radio" name="fm" id="r_v5"><span>Propalcote M</span></div>
            <div class="f-mat-card" id="card_vM" onclick="selMat('vM')"><input type="radio" name="fm" id="r_vM"><span>Manual</span></div>
        </div>

        <div class="extra-input-row" style="margin-top:15px; text-align:left;">
            <label style="color:#888">Extra $</label>
            <input type="number" id="f_extra" value="0" oninput="runFlexo()" style="width:70px;">
        </div>

        <div class="total-box">
            <div id="f_msg" style="font-size:11px; font-weight:bold; margin-bottom:5px; color:#c62828;"></div>
            <div style="font-size:13px;">SUBTOTAL: <span id="f_sub">$ 0.00</span></div>
            <div style="font-size:13px;"><span id="lbl_iva_flexo">IVA:</span> <span id="f_iva">$ 0.00</span></div>
            <div class="total-val" style="color:#1b5e20;" id="f_total">$ 0.00</div>
        </div>

        <div class="print-only firma-box"><div class="firma-line">Firma Autorizada</div></div>
        <button class="btn-action no-print" style="background:var(--ws-color); color:white;" onclick="wsAction('flexo')">üí¨ WhatsApp Flexo</button>
        <button class="btn-action no-print" style="background:var(--s-color); color:white;" onclick="window.print()">üñ®Ô∏è Imprimir Flexo</button>
    </main>

    <div id="config-panel" class="no-print">
        <div class="config-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <strong>AJUSTES MASTER</strong>
                <button onclick="toggleConfig(false)" style="border:none; background:none; font-size:20px;">‚úï</button>
            </div>
            <div class="config-section">
                <div class="grid-inputs">
                    <button onclick="toggleLogic(true)" style="background:#eee; border:none; padding:5px 10px; border-radius:5px; font-size:10px; cursor:pointer;">‚ÑπÔ∏è Ver Documentaci√≥n T√©cnica</button>
                    <button onclick="checkPass()" style="font-size:10px; padding:5px;">üîì Desbloquear Precios</button>
                    <label>Logo:</label><input type="file" onchange="subirLogo(this)">
                    <label>IVA %</label><input type="number" id="conf_iva" disabled>
                    <label>Cirel cm¬≤ $</label><input type="number" id="conf_cirel" step="0.001" disabled>
                    <label>PoliP Blanco $</label><input type="number" id="conf_v1" step="0.000001" disabled>
                    <label>PoliP Trans $</label><input type="number" id="conf_v2" step="0.000001" disabled>
                    <label>PoliP Metal $</label><input type="number" id="conf_v3" step="0.000001" disabled>
                    <label>Propalcote B $</label><input type="number" id="conf_v4" step="0.000001" disabled>
                    <label>Propalcote M $</label><input type="number" id="conf_v5" step="0.000001" disabled>
                    <label>Manual $</label><input type="number" id="conf_vM" step="0.000001" disabled>
                </div>
            </div>
            <button class="btn-action" style="background:var(--p-color); color:white;" onclick="saveAll()">GUARDAR TODO</button>
        </div>
    </div>

    <div id="info-logic-panel" class="no-print">
        <div class="config-content" style="background:#fff; padding:20px; border-radius:15px; line-height:1.6; font-size:12px; max-height: 85vh; overflow-y: auto;">
            <h3 style="color:var(--p-color); margin-top:0; border-bottom: 2px solid var(--p-color);">Estructura L√≥gica y F√≥rmulas</h3>
            
            <p><strong>1. PROCESO CIREL (Fotopol√≠meros):</strong></p>
            <ul>
                <li><strong>C√°lculo de Bloque:</strong> Determina el espacio f√≠sico ocupado por las etiquetas incluyendo sus separaciones (Gaps).</li>
                <li><strong>M√°rgenes de Seguridad:</strong> 
                    <br>‚Ä¢ <i>Con Gu√≠as:</i> Suma 9mm perimetrales para marcas de registro.
                    <br>‚Ä¢ <i>Neto:</i> Solo suma 3mm en el alto para pinza de sujeci√≥n.
                </li>
                <li><strong>√Årea de Cobro (F√≥rmula Maestra):</strong> Se calcula el √°rea t√©cnica sumando un margen de 2cm perimetrales adicionales por el desperdicio natural del material.
                    <br>$$Area = (Ancho(cm)+2) \times (Alto(cm)+2) \times Cantidad$$
                </li>
            </ul>

            <p><strong>2. PROCESO FLEXO (Impresi√≥n):</strong></p>
            <ul>
                <li><strong>Linealidad y Metraje:</strong> Calcula cu√°ntos metros de material se consumen basados en el paso del cilindro (Bloque).
                    <br>$$Metros = \frac{Pedido Total}{Etiquetas \times Bloque} \times \frac{Largo Bloque}{100}$$
                </li>
                <li><strong>Escala de Costos Din√°mica:</strong> Aplica un factor de correcci√≥n seg√∫n el volumen para cubrir tiempos de montaje:
                    <br>‚Ä¢ < 3,000 unid: <b>+25%</b> sobre el costo base.
                    <br>‚Ä¢ < 5,000 unid: <b>+15%</b> sobre el costo base.
                </li>
            </ul>

            <p><strong>3. TALLER Z (C√°lculo de Cilindros):</strong></p>
            <ul>
                <li><strong>Paso Te√≥rico:</strong> Se basa en el sistema de pi√±oner√≠a est√°ndar de 1/8" ($3.175mm$).</li>
                <li><strong>Compensaci√≥n por Estiramiento:</strong> Resta el 1.7% ($0.983$) al desarrollo para compensar la deformaci√≥n del pol√≠mero al ser montado en el cilindro curvo.</li>
            </ul>
            
            <button class="btn-action" onclick="toggleLogic(false)" style="background:var(--p-color); color:white;">CERRAR DOCUMENTACI√ìN</button>
        </div>
    </div>
</div>

<script>
    const PASO = 3.175;
    let masterMode = 'guias', currentMat = 'v1';

    window.onload = () => {
        document.getElementById('fecha').value = new Date().toLocaleDateString();
        loadAll(); runCirel(); runFlexo();
        updatePrintTitle('cirel'); 
    };

    function toggleConfig(s) { document.getElementById('config-panel').style.display = s ? 'block' : 'none'; }
    function toggleLogic(s) { document.getElementById('info-logic-panel').style.display = s ? 'block' : 'none'; }
    function checkPass() { if(prompt("Clave:") === "1234") document.querySelectorAll('.config-content input').forEach(i => i.disabled = false); }

    function switchApp(id) {
        document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'mod_cirel') {
            document.getElementById('btn-cirel').classList.add('active');
            updatePrintTitle('cirel');
        } else {
            document.getElementById('btn-flexo').classList.add('active');
            updatePrintTitle('flexo');
        }
    }

    function updatePrintTitle(type) {
        const titleE = document.getElementById('main-print-title');
        titleE.innerText = type === 'cirel' ? 'PROFORMA CIRELES' : 'PROFORMA ETIQUETAS';
    }

    function toggleSec(id) {
        const sec = document.getElementById(id);
        const d = sec.style.display;
        document.querySelectorAll('.collapsible-content').forEach(s => s.style.display = 'none');
        sec.style.display = (d === 'block') ? 'none' : 'block';
    }

    function setMasterMode(m) {
        masterMode = m;
        document.getElementById('mode-guias').className = m === 'guias' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('mode-neto').className = m === 'neto' ? 'mode-btn active' : 'mode-btn';
        runCirel();
    }

    function selMat(id) {
        currentMat = id;
        document.querySelectorAll('.f-mat-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('card_' + id).classList.add('selected');
        runFlexo();
    }

    function getCData(w, h, gh, gv, tot, col, costo, ivaP, mode) {
        const filas = Math.ceil(tot/col);
        const bW = (col * w) + ((col-1)*gh), bH = (filas * h) + ((filas-1)*gv);
        let mW = mode === 'guias' ? bW + 9 : bW, mH = mode === 'guias' ? bH + 9 : bH + 3;
        let cobW = (mW/10)+2, cobH = (mH/10)+2;
        let sub = (cobW * cobH) * costo;
        return { bW, bH, mW, mH, cobW, cobH, sub, total: sub * (1 + ivaP/100) };
    }

    function runCirel() {
        const w = parseFloat(document.getElementById('cw').value)||0, h = parseFloat(document.getElementById('ch').value)||0,
              gh = parseFloat(document.getElementById('cgh').value)||0, gv = parseFloat(document.getElementById('cgv').value)||0,
              col = parseFloat(document.getElementById('ccol').value)||1, tot = parseFloat(document.getElementById('ctot').value)||0,
              ncir = parseFloat(document.getElementById('cn_cir').value)||1,
              costo = parseFloat(localStorage.getItem('mf_cirel'))||0.06, ivaP = parseFloat(localStorage.getItem('mf_iva'))||15;

        const res = getCData(w, h, gh, gv, tot, col, costo, ivaP, masterMode);
        const rot = getCData(h, w, gv, gh, tot, col, costo, ivaP, masterMode); 
        
        const sub = (res.cobW * res.cobH) * ncir * costo;
        const iva = sub * (ivaP/100);

        document.getElementById('lbl_iva_cirel').innerText = `IVA (${ivaP}%):`;
        document.getElementById('cr_bloque').innerText = res.bW.toFixed(1) + "x" + res.bH.toFixed(1) + " mm";
        document.getElementById('cr_aux').innerText = res.mW.toFixed(1) + "x" + res.mH.toFixed(1) + " mm";
        document.getElementById('cr_cobro').innerText = res.cobW.toFixed(2) + "x" + res.cobH.toFixed(2) + " cm";
        document.getElementById('cr_area').innerText = ((res.cobW * res.cobH) * ncir).toFixed(2) + " cm¬≤";
        document.getElementById('cr_sub').innerText = "$ " + sub.toFixed(2);
        document.getElementById('cr_iva').innerText = "$ " + iva.toFixed(2);
        document.getElementById('cr_total').innerText = "$ " + (sub + iva).toFixed(2);

        const mejorN = (res.total <= (rot.total + 0.01));
        document.getElementById('cr_tabla_opt').innerHTML = `<table class="tabla-opt"><tr class="${mejorN?'mejor-fila':''}"><td>Normal</td><td>${res.cobW.toFixed(2)}x${res.cobH.toFixed(2)}</td><td>$${(res.sub*(1+ivaP/100)).toFixed(2)}</td></tr><tr class="${!mejorN?'mejor-fila':''}"><td>Rotada</td><td>${rot.cobW.toFixed(2)}x${rot.cobH.toFixed(2)}</td><td>$${(rot.sub*(1+ivaP/100)).toFixed(2)}</td></tr></table>`;

        let zs = 0; for(let z=30; z<=120; z++) { if((z * PASO) >= (res.mH + 0.5)) { zs = z; break; } }
        document.getElementById('z_manual').value = zs; calcZManual();
        document.getElementById('ctx-h').innerText = (res.mW/10).toFixed(2) + " cm";
        document.getElementById('ctx-v').innerText = (res.mH/10).toFixed(2) + " cm";
        const areaE = document.getElementById('area-cirel'); areaE.style.width = res.mW + "px"; areaE.style.height = res.mH + "px";
        const vis = document.getElementById('vis'); vis.innerHTML = '';
        const oX = (masterMode === 'guias' ? 4.5 : 0), oY = (masterMode === 'guias' ? 6 : 0);
        for(let i=0; i<tot; i++){
            const r = Math.floor(i/col), c = i%col;
            const d = document.createElement('div'); d.className = 'etiqueta-v'; d.style.width = w+"px"; d.style.height = h+"px";
            d.style.left = (oX + (c*(w+gh))) + "px"; d.style.top = (oY + (r*(h+gv))) + "px"; vis.appendChild(d);
        }
    }

    function runFlexo() {
        const cmB = parseFloat(document.getElementById('f_cmB').value)||0, etB = parseFloat(document.getElementById('f_etB').value)||0,
              totE = parseFloat(document.getElementById('f_tot').value)||0, anc = parseFloat(document.getElementById('f_anc').value)||0,
              ext = parseFloat(document.getElementById('f_extra').value)||0, ivaP = parseFloat(localStorage.getItem('mf_iva'))||15,
              costoBase = parseFloat(localStorage.getItem('mf_' + currentMat))||0.00015783;

        const bloques = totE/etB, lin = bloques * cmB, area = lin * anc;
        let f = 1.0; 
        let recargoTexto = "";
        
        if(totE <= 3000) { f = 1.25; recargoTexto = "‚ö†Ô∏è Recargo Cantidad M√≠nima (+25%)"; } 
        else if(totE <= 5000) { f = 1.15; recargoTexto = "‚ö†Ô∏è Recargo Cantidad M√≠nima (+15%)"; }

        const sub = (area * costoBase * f) + ext;
        const iva = sub * (ivaP/100);

        document.getElementById('lbl_iva_flexo').innerText = `IVA (${ivaP}%):`;
        document.getElementById('f_res_bloques').innerText = bloques.toFixed(2);
        document.getElementById('f_res_cm').innerText = lin.toFixed(1) + " cm";
        document.getElementById('f_res_area').innerText = area.toFixed(0) + " cm¬≤";
        document.getElementById('f_res_m').innerText = (lin/100).toFixed(2) + " m";
        document.getElementById('f_res_ft').innerText = (lin/30.48).toFixed(2) + " ft";
        document.getElementById('f_sub').innerText = "$ " + sub.toFixed(2);
        document.getElementById('f_iva').innerText = "$ " + iva.toFixed(2);
        document.getElementById('f_total').innerText = "$ " + (sub + iva).toFixed(2);
        document.getElementById('f_msg').innerText = recargoTexto;
    }

    function calcZManual() {
        const z = parseFloat(document.getElementById('z_manual').value)||0;
        document.getElementById('cr_teo').innerText = (z * PASO).toFixed(2) + " mm";
        document.getElementById('cr_comp').innerText = (z * PASO * 0.983).toFixed(2) + " mm";
    }

    function saveAll() {
        const ids = ['iva', 'cirel', 'v1', 'v2', 'v3', 'v4', 'v5', 'vM'];
        ids.forEach(id => localStorage.setItem('mf_' + id, document.getElementById('conf_' + id).value));
        toggleConfig(false); runCirel(); runFlexo();
    }

    function loadAll() {
        const ids = ['iva', 'cirel', 'v1', 'v2', 'v3', 'v4', 'v5', 'vM'];
        const defs = [15, 0.06, 0.00015783, 0.00015783, 0.00023805, 0.0001669, 0.0002169, 0.000439];
        ids.forEach((id, i) => {
            const val = localStorage.getItem('mf_' + id);
            document.getElementById('conf_' + id).value = val ? val : defs[i];
        });
        const l = localStorage.getItem('mf_logo'); if(l) { document.getElementById('logo-preview').src = l; document.getElementById('logo-preview').style.display='block'; }
    }

    function subirLogo(i) {
        if(i.files && i.files[0]) {
            const r = new FileReader(); r.onload = e => { localStorage.setItem('mf_logo', e.target.result); loadAll(); }; r.readAsDataURL(i.files[0]);
        }
    }

    function wsAction(app) {
        const c = document.getElementById('c_nom').value;
        const t = app === 'cirel' ? `*CIREL PRO*%0ACliente: ${c}%0AArea: ${document.getElementById('cr_cobro').innerText}%0ATotal: ${document.getElementById('cr_total').innerText}` : `*FLEXO PRO*%0ACliente: ${c}%0AMedida: ${document.getElementById('f_res_cm').innerText}%0ATotal: ${document.getElementById('f_total').innerText}`;
        window.open("https://wa.me/?text="+t);
    }
    
    // REGISTRO DEL SERVICE WORKER CORREGIDO
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Usamos la ruta relativa ./ para GitHub Pages
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registrado con √©xito'))
            .catch(err => console.log('Error de registro:', err));
    });
    }
</script>
</body>
</html>

